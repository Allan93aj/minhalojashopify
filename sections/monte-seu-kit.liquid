{{ 'section_monte-seu-kit.css' | asset_url | stylesheet_tag }}
<script src="{{ 'monte-seu-kit.js' | asset_url }}" defer></script>

{% comment %}
Section: Kit Builder Dinâmico
Este componente cria uma montagem de kit com produtos dinâmicos a partir das coleções da loja.
{% endcomment %}

<section class="kit-builder-section">
  <div class="kit-builder-container">
    <h2 class="kit-builder-title">{{ section.settings.title }}</h2>

    <div class="kit-builder-steps">
      {% for i in (1..3) %}
        {% assign select_key = 'select_placeholder_' | append: i %}
        {% assign collection_key = 'collection_' | append: i %}
        {% assign select_placeholder = section.settings[select_key] %}
        {% assign collection_handle = section.settings[collection_key] %}
        {% assign collection_obj = collections[collection_handle] %}

        <div class="kit-step" id="kit-step-{{ i }}">
          <h3 class="step-title">Passo {{ i }}: {{ select_placeholder }}</h3>

          {% if collection_obj != blank %}
            <div class="kit-products-grid">
              {% for product in collection_obj.products %}
                <div class="kit-product-card" data-product-id="{{ product.id }}">
                  <img src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title }}">
                  <h4>{{ product.title }}</h4>
                  <p class="kit-product-price">{{ product.price | money }}</p>
                  <button class="select-product-btn" data-handle="{{ product.handle }}">Selecionar</button>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="no-products">Selecione uma coleção no editor para este passo.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="kit-summary">
      <h3>Seu Kit:</h3>
      <div id="selected-products"></div>
      <button id="add-kit-to-cart" disabled>Adicionar Kit ao Carrinho</button>
    </div>
  </div>
</section>

<style>
.kit-builder-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 20px;
}
.kit-builder-title {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 30px;
}
.kit-step {
  margin-bottom: 40px;
}
.kit-products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
}
.kit-product-card {
  border: 1px solid #ddd;
  padding: 15px;
  text-align: center;
  border-radius: 8px;
  transition: 0.3s;
}
.kit-product-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.kit-product-card img {
  width: 100%;
  height: auto;
  margin-bottom: 10px;
}
.select-product-btn {
  background: #000;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 5px;
  cursor: pointer;
  transition: 0.3s;
}
.select-product-btn:hover {
  background: #333;
}
.kit-summary {
  text-align: center;
  border-top: 1px solid #ddd;
  padding-top: 30px;
}
#selected-products {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
}
#selected-products .kit-product-card {
  max-width: 150px;
}
#add-kit-to-cart {
  background: #007b5e;
  color: #fff;
  border: none;
  padding: 12px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
#add-kit-to-cart:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const selectedProductsContainer = document.getElementById('selected-products');
  const addKitBtn = document.getElementById('add-kit-to-cart');
  let selectedProducts = [];

  document.querySelectorAll('.select-product-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.kit-product-card');
      const productId = card.dataset.productId;
      const productTitle = card.querySelector('h4').innerText;
      const productImg = card.querySelector('img').src;
      const productPrice = card.querySelector('.kit-product-price').innerText;

      if (!selectedProducts.find(p => p.id === productId)) {
        selectedProducts.push({
          id: productId,
          title: productTitle,
          img: productImg,
          price: productPrice,
          handle: btn.dataset.handle
        });
      }

      renderSelectedProducts();
    });
  });

  function renderSelectedProducts() {
    selectedProductsContainer.innerHTML = '';
    selectedProducts.forEach(p => {
      const div = document.createElement('div');
      div.classList.add('kit-product-card');
      div.innerHTML = `
        <img src="${p.img}" alt="${p.title}">
        <h4>${p.title}</h4>
        <p>${p.price}</p>
        <button class="remove-product-btn" data-id="${p.id}">Remover</button>
      `;
      selectedProductsContainer.appendChild(div);
    });

    addKitBtn.disabled = selectedProducts.length === 0;

    document.querySelectorAll('.remove-product-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedProducts = selectedProducts.filter(p => p.id !== btn.dataset.id);
        renderSelectedProducts();
      });
    });
  }

  addKitBtn.addEventListener('click', () => {
    const items = selectedProducts.map(p => ({
      id: parseInt(p.id),
      quantity: 1
    }));

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    }).then(res => res.json())
      .then(() => {
        alert('Kit adicionado ao carrinho!');
        selectedProducts = [];
        renderSelectedProducts();
      });
  });
});
</script>

{% schema %}
{
  "name": "Kit Builder Dinâmico",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título da Seção",
      "default": "Monte seu Kit"
    },
    {
      "type": "header",
      "content": "Passo 1"
    },
    {
      "type": "text",
      "id": "select_placeholder_1",
      "label": "Título do Passo 1",
      "default": "Escolha o primeiro produto"
    },
    {
      "type": "collection",
      "id": "collection_1",
      "label": "Coleção - Passo 1"
    },
    {
      "type": "header",
      "content": "Passo 2"
    },
    {
      "type": "text",
      "id": "select_placeholder_2",
      "label": "Título do Passo 2",
      "default": "Escolha o segundo produto"
    },
    {
      "type": "collection",
      "id": "collection_2",
      "label": "Coleção - Passo 2"
    },
    {
      "type": "header",
      "content": "Passo 3"
    },
    {
      "type": "text",
      "id": "select_placeholder_3",
      "label": "Título do Passo 3",
      "default": "Escolha o terceiro produto"
    },
    {
      "type": "collection",
      "id": "collection_3",
      "label": "Coleção - Passo 3"
    }
  ],
  "presets": [
    {
      "name": "Kit Builder Dinâmico",
      "category": "Kits"
    }
  ]
}
{% endschema %}
