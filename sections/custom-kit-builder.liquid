{{ 'section_monte-seu-kit.css' | asset_url | stylesheet_tag }}

{% comment %} Capturar as categorias selecionadas no schema {% endcomment %}
{% assign step1_collection = section.settings.step1_collection %}
{% assign step2_collection = section.settings.step2_collection %}
{% assign step3_collection = section.settings.step3_collection %}

<!-- HTML do Builder -->
<div class="kit-builder-container">
  <div class="steps-selects">
    <!-- Step 1 - Dropdown Customizado -->
    <div class="step-select" data-step="1">
      <label>Passo 1</label>
      <div class="custom-dropdown" id="step1-dropdown">
        <button class="dropdown-button" type="button">
          <span class="dropdown-label">{{ section.settings.step1_label | default: 'PRODUTO 1' }}</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M2 4l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step1-menu"></div>
      </div>
    </div>

    <!-- Step 2 - Dropdown Customizado -->
    <div class="step-select" data-step="2">
      <label>Passo 2</label>
      <div class="custom-dropdown disabled" id="step2-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">{{ section.settings.step2_label | default: 'PRODUTO 2' }}</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M2 4l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step2-menu"></div>
      </div>
    </div>

    <!-- Step 3 - Dropdown Customizado -->
    <div class="step-select" data-step="3">
      <label>Passo 3</label>
      <div class="custom-dropdown disabled" id="step3-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">{{ section.settings.step3_label | default: 'PRODUTO 3' }}</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M2 4l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step3-menu"></div>
      </div>
    </div>
  </div>

  <div id="products-container" class="products-grid"></div>

  <div id="next-step-button-container" class="buttons-container">
    <button id="voltar-button" class="btn btn-secondary">Voltar</button>
    <button id="next-step-button" class="btn btn-primary">Próximo passo</button>
    <button id="finalizar-button" class="btn btn-primary" style="display:none;">Finalizar</button>
  </div>

  <button id="resumo-btn" class="btn btn-summary">Resumo</button>

  <div id="resumo-section" style="display:none;">
    <div id="resumo-content"></div>
    <p>Total: <span id="resumo-total-value"></span></p>
    <button id="resumo-voltar-button" class="btn btn-secondary">Voltar</button>
    <button id="add-to-cart-button" class="btn btn-primary">Adicionar ao carrinho</button>
  </div>
</div>

<!-- JS completo -->
<script>
const state = {
  categories: {
    step1: "{{ step1_collection }}",
    step2: "{{ step2_collection }}",
    step3: "{{ step3_collection }}"
  },
  allProducts: [
    {% if step1_collection != blank %}
      {% assign collection1 = collections[step1_collection] %}
      {% for product in collection1.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ step1_collection }}",
        step: 1,
        price: {{ product.variants.first.price | money_without_currency | remove: ',' | divided_by: 100 }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
    {% if step2_collection != blank %}
      {% assign collection2 = collections[step2_collection] %}
      {% if step1_collection != blank %},{% endif %}
      {% for product in collection2.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ step2_collection }}",
        step: 2,
        price: {{ product.variants.first.price | money_without_currency | remove: ',' | divided_by: 100 }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
    {% if step3_collection != blank %}
      {% assign collection3 = collections[step3_collection] %}
      {% if step1_collection != blank or step2_collection != blank %},{% endif %}
      {% for product in collection3.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ step3_collection }}",
        step: 3,
        price: {{ product.variants.first.price | money_without_currency | remove: ',' | divided_by: 100 }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ],
  selectedCategories: { step1:null, step2:null, step3:null },
  selectedProducts: { step1:null, step2:null, step3:null },
  displayedProducts: [],
  currentStep: null,
  showResumo: false
};

// ===== FUNÇÕES DROPDOWN CUSTOMIZADO =====
function initCustomDropdowns() {
  const steps = [
    { id: 'step1', num: 1, category: state.categories.step1 },
    { id: 'step2', num: 2, category: state.categories.step2 },
    { id: 'step3', num: 3, category: state.categories.step3 }
  ];

  steps.forEach(({ id, num, category }) => {
    if (!category) return; // Pular se não tiver categoria selecionada
    
    const dropdown = document.getElementById(`${id}-dropdown`);
    const button = dropdown.querySelector('.dropdown-button');
    const menu = document.getElementById(`${id}-menu`);
    const label = dropdown.querySelector('.dropdown-label');
    
    // Atualizar label com o nome da categoria
    label.textContent = capitalizeFirst(category);
    
    // Criar opção única (já que cada step tem uma categoria fixa)
    const option = document.createElement('div');
    option.className = 'dropdown-option selected';
    option.textContent = capitalizeFirst(category);
    option.dataset.value = category;
    option.addEventListener('click', () => {
      selectDropdownOption(id, num, category, option);
    });
    menu.appendChild(option);
    
    // Auto-selecionar ao clicar no botão
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!button.disabled) {
        handleStepChange(num, category);
      }
    });
  });
  
  // Fechar ao clicar fora
  document.addEventListener('click', () => closeAllDropdowns());
}

function selectDropdownOption(step, stepNum, value, optionElement) {
  const dropdown = document.getElementById(`${step}-dropdown`);
  const label = dropdown.querySelector('.dropdown-label');
  
  // Atualizar label
  label.textContent = capitalizeFirst(value);
  
  // Marcar opção selecionada
  dropdown.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
  optionElement.classList.add('selected');
  
  // Fechar dropdown
  dropdown.classList.remove('open');
  
  // Chamar lógica de seleção (substitui o onChange do select)
  handleStepChange(stepNum, value);
}

function closeAllDropdowns() {
  document.querySelectorAll('.custom-dropdown').forEach(dd => dd.classList.remove('open'));
}

function enableDropdown(stepNum) {
  const dropdown = document.getElementById(`step${stepNum}-dropdown`);
  const button = dropdown.querySelector('.dropdown-button');
  dropdown.classList.remove('disabled');
  button.disabled = false;
}

// ===== FUNÇÕES ORIGINAIS =====
function formatPrice(price){ return 'R$ '+price.toFixed(2).replace('.',','); }
function capitalizeFirst(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function filterProductsByCategory(category){
  return state.allProducts.filter(p=>p.category===category);
}

function filterProductsByStep(step){
  return state.allProducts.filter(p=>p.step===step);
}

function createProductCard(product, step){
  const card = document.createElement('div');
  card.className = 'product-card';
  const checkboxId = `product-${step}-${product.id}`;
  const isSelected = state.selectedProducts[`step${step}`]?.id===product.id;
  card.innerHTML = `
    <div class="product-checkbox-container">
      <input type="checkbox" class="product-checkbox" id="${checkboxId}" data-product-id="${product.id}" data-step="${step}" ${isSelected?'checked':''}>
    </div>
    <img src="${product.image}" alt="${product.title}" class="product-image">
    <div class="product-info">
      <h3 class="product-title">${product.title.length>50?product.title.substring(0,50)+'...':product.title}</h3>
      <p class="product-category">${capitalizeFirst(product.category)}</p>
      <p class="product-price">${formatPrice(Number(product.price))}</p>
    </div>
  `;
  if(!isSelected && state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
  card.querySelector('.product-checkbox').addEventListener('change', handleProductSelection);
  return card;
}

function handleProductSelection(e){
  const cb = e.target;
  const step = cb.dataset.step;
  const product = state.displayedProducts.find(p=>p.id==cb.dataset.productId);
  if(cb.checked){
    state.selectedProducts[`step${step}`]=product;
    document.querySelectorAll(`.product-checkbox[data-step="${step}"]`).forEach(x=>{ if(x.id!==cb.id)x.checked=false; });
  } else state.selectedProducts[`step${step}`]=null;
  updateProductCardsOpacity(step); updateButtons(); updateResumo();
}

function updateProductCardsOpacity(step){
  document.querySelectorAll('.product-card').forEach(card=>{
    const cb=card.querySelector('.product-checkbox');
    if(cb?.dataset.step===step){
      if(cb.checked) card.classList.remove('product-card--disabled');
      else if(state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
      else card.classList.remove('product-card--disabled');
    }
  });
}

function displayProducts(products, step){
  const container = document.getElementById('products-container');
  if(state.showResumo){ container.style.display='none'; return; }
  container.style.display='grid'; container.innerHTML='';
  
  // Filtrar produtos do step específico
  const stepProducts = filterProductsByStep(step);
  
  if(!stepProducts.length) {
    container.innerHTML='<p class="loading">Nenhum produto disponível para o Passo '+step+'</p>';
  } else {
    stepProducts.forEach(p=>container.appendChild(createProductCard(p,step)));
  }
  
  state.displayedProducts=stepProducts; 
  state.currentStep=step;
  updateProductCardsOpacity(step); 
  updateButtons();
}

function goToNextStep(){
  if(!state.currentStep || !state.selectedProducts[`step${state.currentStep}`]) return;
  const next = parseInt(state.currentStep)+1;
  if(next<=3){
    enableDropdown(next);
    displayProducts([],next);
  }
}

function goToPreviousStep(){
  if(!state.currentStep || state.currentStep==1) return;
  const prev=parseInt(state.currentStep)-1;
  enableDropdown(prev);
  displayProducts([], prev);
}

function showResumo(){
  state.showResumo=true;
  document.getElementById('products-container').style.display='none';
  document.getElementById('next-step-button-container').style.display='none';
  updateResumo();
  document.getElementById('resumo-section').style.display='block';
  document.getElementById('resumo-section').scrollIntoView({behavior:'smooth',block:'start'});
}

function goBackFromResumo(){
  state.showResumo=false;
  displayProducts([], 3);
  document.getElementById('resumo-section').style.display='none';
}

function updateResumo(){
  const content=document.getElementById('resumo-content');
  const totalValue=document.getElementById('resumo-total-value');
  let html=''; let total=0;
  for(let i=1;i<=3;i++){
    const prod=state.selectedProducts[`step${i}`];
    const cat=state.selectedCategories[`step${i}`];
    if(prod){ html+=`<div class="resumo-step"><h3>Produto ${i}: ${cat}</h3>
      <div class="resumo-item">
        <img src="${prod.image}" class="resumo-image">
        <div class="resumo-item-info">
          <p class="resumo-item-title">${prod.title}</p>
          <p class="resumo-item-price">${formatPrice(Number(prod.price))}</p>
        </div>
      </div></div>`;
      total+=Number(prod.price);
    }
  }
  content.innerHTML=html; totalValue.textContent=`${formatPrice(total)}`;
}

function handleStepChange(step,val){
  state.selectedCategories[`step${step}`]=val;
  state.selectedProducts[`step${step}`]=null;
  displayProducts([], step);
}

function updateButtons(){
  const next=document.getElementById('next-step-button');
  const finalizar=document.getElementById('finalizar-button');
  const voltar=document.getElementById('voltar-button');
  const cont=document.getElementById('next-step-button-container');
  if(state.showResumo){ cont.style.display='none'; return; }
  if(state.currentStep && state.selectedProducts[`step${state.currentStep}`]){
    cont.style.display='block';
    voltar.style.display=state.currentStep>1?'inline-block':'none';
    if(state.currentStep==3){ next.style.display='none'; finalizar.style.display='inline-block'; finalizar.disabled=false; }
    else{ next.style.display='inline-block'; finalizar.style.display='none'; next.disabled=false; }
  } else { cont.style.display='none'; next.disabled=true; finalizar.disabled=true; }
}

function showInitialScreen(){
  document.getElementById('products-container').innerHTML='<p class="loading">Clique em Produto 1 para escolher o produto</p>';
}

// Adicionar produtos ao carrinho Shopify AJAX
function addProductsToCart(){
  const items = [];
  for(let i=1;i<=3;i++){
    const prod=state.selectedProducts[`step${i}`];
    if(prod) items.push({ id: prod.variantId, quantity: 1 });
  }
  if(!items.length) return alert('Nenhum produto selecionado');
  
  fetch('/cart/add.js', {
    method:'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items })
  })
  .then(res=>res.json())
  .then(data=>{ alert('Produtos adicionados ao carrinho com sucesso!'); })
  .catch(err=>{ console.error(err); alert('Erro ao adicionar ao carrinho'); });
}

document.addEventListener('DOMContentLoaded',()=>{
  showInitialScreen();
  initCustomDropdowns(); // Inicializar dropdowns customizados

  document.getElementById('next-step-button').addEventListener('click',goToNextStep);
  document.getElementById('finalizar-button').addEventListener('click',showResumo);
  document.getElementById('voltar-button').addEventListener('click',goToPreviousStep);
  document.getElementById('resumo-voltar-button').addEventListener('click',goBackFromResumo);
  document.getElementById('resumo-btn').addEventListener('click',showResumo);
  document.getElementById('add-to-cart-button').addEventListener('click',addProductsToCart);
});
</script>

{% schema %}
{
  "name": "Monte seu Kit",
  "settings": [
    {
      "type": "header",
      "content": "Configurações do Kit Builder"
    },
    {
      "type": "paragraph",
      "content": "Selecione as categorias (coleções) que aparecerão em cada passo do kit."
    },
    {
      "type": "collection",
      "id": "step1_collection",
      "label": "Passo 1 - Coleção",
      "info": "Escolha a coleção de produtos para o primeiro passo"
    },
    {
      "type": "collection",
      "id": "step2_collection",
      "label": "Passo 2 - Coleção",
      "info": "Escolha a coleção de produtos para o segundo passo"
    },
    {
      "type": "collection",
      "id": "step3_collection",
      "label": "Passo 3 - Coleção",
      "info": "Escolha a coleção de produtos para o terceiro passo"
    },
    {
      "type": "header",
      "content": "Textos Personalizados"
    },
    {
      "type": "text",
      "id": "step1_label",
      "label": "Texto Passo 1",
      "default": "PRODUTO 1",
      "info": "Texto que aparece no botão do passo 1"
    },
    {
      "type": "text",
      "id": "step2_label",
      "label": "Texto Passo 2",
      "default": "PRODUTO 2",
      "info": "Texto que aparece no botão do passo 2"
    },
    {
      "type": "text",
      "id": "step3_label",
      "label": "Texto Passo 3",
      "default": "PRODUTO 3",
      "info": "Texto que aparece no botão do passo 3"
    },
    {
      "type": "header",
      "content": "Botões"
    },
    {
      "type": "text",
      "id": "btn_next",
      "label": "Texto Botão Próximo",
      "default": "Próximo passo"
    },
    {
      "type": "text",
      "id": "btn_back",
      "label": "Texto Botão Voltar",
      "default": "Voltar"
    },
    {
      "type": "text",
      "id": "btn_finish",
      "label": "Texto Botão Finalizar",
      "default": "Finalizar"
    },
    {
      "type": "text",
      "id": "btn_summary",
      "label": "Texto Botão Resumo",
      "default": "Resumo"
    },
    {
      "type": "text",
      "id": "btn_add_cart",
      "label": "Texto Botão Adicionar ao Carrinho",
      "default": "Adicionar ao carrinho"
    }
  ],
  "presets": [
    {
      "name": "Monte seu Kit",
      "category": "Custom"
    }
  ]
}
{% endschema %}