{{ 'section_monte-seu-kit.css' | asset_url | stylesheet_tag }}

<!-- HTML do Builder -->
<div class="kit-builder-container">
  <div class="steps-selects">
    <div class="step-select" data-step="1">
      <label>Passo 1</label>
      <div class="custom-dropdown" id="step1-dropdown">
        <button class="dropdown-button active" type="button">
          <span class="dropdown-label">PRODUTO 1</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="dropdown-menu" id="step1-menu"></div>
      </div>
    </div>

    <div class="step-select" data-step="2">
      <label>Passo 2</label>
      <div class="custom-dropdown disabled" id="step2-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 2</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="dropdown-menu" id="step2-menu"></div>
      </div>
    </div>

    <div class="step-select" data-step="3">
      <label>Passo 3</label>
      <div class="custom-dropdown disabled" id="step3-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 3</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="dropdown-menu" id="step3-menu"></div>
      </div>
    </div>
  </div>

  <div id="products-container" class="products-grid"></div>

  <div id="next-step-button-container" class="buttons-container" style="display:none;">
    <button id="back-step-button" class="btn btn-secondary" style="display:none;">Voltar</button>
    <button id="next-step-button" class="btn btn-primary disabled">Próximo passo</button>
    <button id="finalizar-button" class="btn btn-success" style="display:none;">Finalizar Kit</button>
  </div>

  <div id="selected-products-section" class="selected-products-container" style="display:none;">
    <h2>Resumo do Kit</h2>
    <div id="selected-products-content"></div>
    <div class="total-section">
      <p class="total-label">Total do Kit:</p>
      <p class="total-value" id="total-value">R$ 0,00</p>
    </div>
    <div class="buttons-resumo">
      <button id="back-to-steps" class="btn btn-secondary">Voltar aos passos</button>
      <button id="add-kit-button" class="btn btn-success">Adicionar Kit ao Carrinho</button>
    </div>
  </div>
</div>

<!-- JS completo -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const state = {
    categories: window.allKitCategories || [],
    allProducts: window.allKitProducts || [],
    selectedCategories: { step1: null, step2: null, step3: null },
    selectedProducts: { step1: null, step2: null, step3: null },
    currentStep: 1,
  };

  const dropdowns = ['step1', 'step2', 'step3'];

  // Popular categorias
  dropdowns.forEach((step, index) => {
    const stepNum = index + 1;
    const menu = document.getElementById(`${step}-menu`);
    state.categories.forEach(cat => {
      const opt = document.createElement('div');
      opt.className = 'dropdown-option';
      opt.textContent = cat;
      opt.addEventListener('click', () => handleCategorySelect(stepNum, cat));
      menu.appendChild(opt);
    });
  });

  // ======= FUNÇÕES =======
  function formatPrice(value) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency', currency: 'BRL'
    }).format(value / 100);
  }

  function handleCategorySelect(step, category) {
    state.selectedCategories[`step${step}`] = category;
    const dropdown = document.getElementById(`step${step}-dropdown`);
    dropdown.querySelector('.dropdown-label').textContent = category;

    document.querySelectorAll('.dropdown-button').forEach(btn => btn.classList.remove('active'));
    dropdown.querySelector('.dropdown-button').classList.add('active');

    displayProducts(step, category);
    showButtons();
  }

  function displayProducts(step, category) {
    const container = document.getElementById('products-container');
    container.innerHTML = '';
    const products = state.allProducts.filter(p => p.category === category);

    products.forEach(prod => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${prod.image}" class="product-image">
        <h3>${prod.title}</h3>
        <p>${formatPrice(prod.price)}</p>
        <input type="checkbox" data-step="${step}" data-id="${prod.id}">
      `;
      card.querySelector('input').addEventListener('change', e => handleProductSelect(e, step, prod));
      container.appendChild(card);
    });
  }

  function handleProductSelect(e, step, product) {
    const checked = e.target.checked;
    const allInputs = document.querySelectorAll(`input[data-step="${step}"]`);
    allInputs.forEach(inp => inp.checked = false);
    e.target.checked = checked;

    state.selectedProducts[`step${step}`] = checked ? product : null;
    document.querySelectorAll('.product-card').forEach(c => c.classList.remove('product-card--disabled'));
    if (checked) {
      document.querySelectorAll(`input[data-step="${step}"]`).forEach(inp => {
        if (!inp.checked) inp.closest('.product-card').classList.add('product-card--disabled');
      });
    }
  }

  function showButtons() {
    document.getElementById('next-step-button-container').style.display = 'flex';
    document.getElementById('next-step-button').onclick = goNext;
    document.getElementById('back-step-button').onclick = goBack;
  }

  function goNext() {
    if (!state.selectedProducts[`step${state.currentStep}`]) return;
    if (state.currentStep < 3) {
      state.currentStep++;
      enableDropdown(state.currentStep);
    } else {
      showResumo();
    }
  }

  function goBack() {
    if (state.currentStep > 1) {
      state.currentStep--;
      enableDropdown(state.currentStep);
      document.getElementById('selected-products-section').style.display = 'none';
      document.getElementById('products-container').style.display = 'grid';
    }
  }

  function enableDropdown(step) {
    dropdowns.forEach((s, i) => {
      const btn = document.querySelector(`#${s}-dropdown .dropdown-button`);
      btn.classList.toggle('active', i + 1 === step);
      btn.disabled = i + 1 > step;
    });
  }

  function showResumo() {
    const resumo = document.getElementById('selected-products-section');
    const content = document.getElementById('selected-products-content');
    const totalValue = document.getElementById('total-value');
    resumo.style.display = 'block';
    document.getElementById('products-container').style.display = 'none';

    let html = '';
    let total = 0;
    for (let i = 1; i <= 3; i++) {
      const p = state.selectedProducts[`step${i}`];
      if (p) {
        html += `
          <div class="selected-product-item">
            <img src="${p.image}" class="selected-product-image">
            <div>
              <p>${p.title}</p>
              <p>${formatPrice(p.price)}</p>
            </div>
          </div>`;
        total += p.price;
      }
    }
    totalValue.textContent = formatPrice(total);
    content.innerHTML = html;

    document.getElementById('back-to-steps').onclick = () => {
      resumo.style.display = 'none';
      document.getElementById('products-container').style.display = 'grid';
      state.currentStep = 3;
      enableDropdown(3);
    };

    document.getElementById('add-kit-button').onclick = addToCart;
  }

  function addToCart() {
    const items = [];
    for (let i = 1; i <= 3; i++) {
      const p = state.selectedProducts[`step${i}`];
      if (p) items.push({ id: p.variantId, quantity: 1 });
    }

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    })
      .then(r => r.json())
      .then(() => window.location.href = '/cart');
  }
});

</script>