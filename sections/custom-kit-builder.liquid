{{ 'section_monte-seu-kit.css' | asset_url | stylesheet_tag }}

<!-- HTML do Builder -->
<div class="kit-builder-container">
  <!-- Header -->
  <div class="kit-builder-header">
    <p class="kit-builder-subtitle">MONTE</p>
    <h1 class="kit-builder-title">SEU KIT</h1>
    <p class="kit-builder-description">Monte seu kit em 3 passos simples</p>
  </div>

  <!-- Steps com Dropdowns Customizados -->
  <div class="steps-selects">
    <div class="step-select" data-step="1">
      <div class="custom-dropdown" id="step1-dropdown">
        <button class="dropdown-button" type="button">
          <span class="dropdown-label">PRODUTO 1</span>
          <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step1-menu">
          <!-- Opções serão inseridas via JS -->
        </div>
      </div>
    </div>

    <div class="step-select" data-step="2">
      <div class="custom-dropdown disabled" id="step2-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 2</span>
          <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step2-menu">
          <!-- Opções serão inseridas via JS -->
        </div>
      </div>
    </div>

    <div class="step-select" data-step="3">
      <div class="custom-dropdown disabled" id="step3-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 3</span>
          <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step3-menu">
          <!-- Opções serão inseridas via JS -->
        </div>
      </div>
    </div>
  </div>

  <div id="products-container" class="products-grid"></div>

  <div id="next-step-button-container" class="buttons-container">
    <button id="voltar-button" class="btn btn-secondary">Voltar</button>
    <button id="next-step-button" class="btn btn-primary">Próximo passo</button>
    <button id="finalizar-button" class="btn btn-primary" style="display:none;">Finalizar</button>
  </div>

  <button id="resumo-btn" class="btn btn-summary">Resumo do Pedido</button>

  <div id="resumo-section" style="display:none;">
    <h2>Resumo do seu Kit</h2>
    <div id="resumo-content"></div>
    <p>Total: <span id="resumo-total-value"></span></p>
    <div class="buttons-container">
      <button id="resumo-voltar-button" class="btn btn-secondary">Voltar</button>
      <button id="add-to-cart-button" class="btn btn-primary">Adicionar ao carrinho</button>
    </div>
  </div>
</div>

<!-- JS completo com Dropdown Customizado -->
<script>
const state = {
  categories: [{% for collection in collections %}"{{ collection.title | escape }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
  allProducts: [
    {% for collection in collections %}
      {% for product in collection.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ collection.title | escape }}",
        price: {{ product.variants.first.price | money_without_currency | remove: ',' | divided_by: 100 }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last and forloop.parentloop.last %}, {% endunless %}
      {% endfor %}
    {% endfor %}
  ],
  selectedCategories: { step1:null, step2:null, step3:null },
  selectedProducts: { step1:null, step2:null, step3:null },
  displayedProducts: [],
  currentStep: null,
  showResumo: false
};

// ===== FUNÇÕES DROPDOWN CUSTOMIZADO =====
function initCustomDropdowns() {
  ['step1', 'step2', 'step3'].forEach((step, index) => {
    const stepNum = index + 1;
    const dropdown = document.getElementById(`${step}-dropdown`);
    const button = dropdown.querySelector('.dropdown-button');
    const menu = document.getElementById(`${step}-menu`);
    
    // Popular menu com categorias
    state.categories.forEach(cat => {
      const option = document.createElement('div');
      option.className = 'dropdown-option';
      option.textContent = capitalizeFirst(cat);
      option.dataset.value = cat;
      option.addEventListener('click', () => selectDropdownOption(step, stepNum, cat, option));
      menu.appendChild(option);
    });
    
    // Toggle dropdown
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!button.disabled) {
        closeAllDropdowns();
        dropdown.classList.toggle('open');
      }
    });
  });
  
  // Fechar ao clicar fora
  document.addEventListener('click', () => closeAllDropdowns());
}

function selectDropdownOption(step, stepNum, value, optionElement) {
  const dropdown = document.getElementById(`${step}-dropdown`);
  const label = dropdown.querySelector('.dropdown-label');
  
  // Atualizar label
  label.textContent = capitalizeFirst(value);
  
  // Marcar opção selecionada
  dropdown.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
  optionElement.classList.add('selected');
  
  // Fechar dropdown
  dropdown.classList.remove('open');
  
  // Chamar lógica de seleção
  handleStepChange(stepNum, value);
}

function closeAllDropdowns() {
  document.querySelectorAll('.custom-dropdown').forEach(dd => dd.classList.remove('open'));
}

function enableDropdown(step) {
  const dropdown = document.getElementById(`step${step}-dropdown`);
  const button = dropdown.querySelector('.dropdown-button');
  dropdown.classList.remove('disabled');
  button.disabled = false;
}

function disableDropdown(step) {
  const dropdown = document.getElementById(`step${step}-dropdown`);
  const button = dropdown.querySelector('.dropdown-button');
  dropdown.classList.add('disabled');
  button.disabled = true;
}

// ===== FUNÇÕES PRINCIPAIS =====
function formatPrice(price){ return 'R$ '+price.toFixed(2).replace('.',','); }
function capitalizeFirst(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function filterProductsByCategory(category){
  return state.allProducts.filter(p=>p.category===category);
}

function createProductCard(product, step){
  const card = document.createElement('div');
  card.className = 'product-card';
  const isSelected = state.selectedProducts[`step${step}`]?.id===product.id;
  
  card.innerHTML = `
    <img src="${product.image}" alt="${product.title}" class="product-image">
    <div class="product-info">
      <h3 class="product-title">${product.title}</h3>
      <div class="product-price-container">
        <span class="product-price">${formatPrice(Number(product.price))}</span>
      </div>
    </div>
  `;
  
  if(isSelected) card.classList.add('selected');
  
  card.addEventListener('click', () => handleProductSelection(product, step));
  
  return card;
}

function handleProductSelection(product, step){
  // Se já está selecionado, desseleciona
  if(state.selectedProducts[`step${step}`]?.id === product.id) {
    state.selectedProducts[`step${step}`] = null;
  } else {
    state.selectedProducts[`step${step}`] = product;
  }
  
  // Atualizar visualização
  displayProducts(state.displayedProducts, step);
  updateButtons();
  updateResumo();
}

function displayProducts(products, step){
  const container = document.getElementById('products-container');
  if(state.showResumo){ container.style.display='none'; return; }
  
  container.style.display='grid'; 
  container.innerHTML='';
  
  if(!products.length) {
    container.innerHTML=`<p class="instruction-message">Clique em <strong>PRODUTO ${step}</strong> para escolher o produto</p>`;
  } else {
    products.forEach(p => container.appendChild(createProductCard(p, step)));
  }
  
  state.displayedProducts = products; 
  state.currentStep = step;
  updateButtons();
}

function goToNextStep(){
  if(!state.currentStep || !state.selectedProducts[`step${state.currentStep}`]) return;
  const next = parseInt(state.currentStep) + 1;
  
  if(next <= 3){
    enableDropdown(next);
    displayProducts([], next);
  }
}

function goToPreviousStep(){
  if(!state.currentStep || state.currentStep == 1) return;
  const prev = parseInt(state.currentStep) - 1;
  
  enableDropdown(prev);
  
  if(state.selectedCategories[`step${prev}`]){
    displayProducts(filterProductsByCategory(state.selectedCategories[`step${prev}`]), prev);
  } else {
    displayProducts([], prev);
  }
}

function showResumo(){
  state.showResumo = true;
  document.getElementById('products-container').style.display = 'none';
  document.getElementById('next-step-button-container').style.display = 'none';
  updateResumo();
  document.getElementById('resumo-section').style.display = 'block';
  document.getElementById('resumo-section').scrollIntoView({behavior:'smooth', block:'start'});
}

function goBackFromResumo(){
  state.showResumo = false;
  displayProducts(filterProductsByCategory(state.selectedCategories['step3']), 3);
  document.getElementById('resumo-section').style.display = 'none';
  document.getElementById('next-step-button-container').style.display = 'flex';
}

function updateResumo(){
  const content = document.getElementById('resumo-content');
  const totalValue = document.getElementById('resumo-total-value');
  let html = ''; 
  let total = 0;
  
  for(let i=1; i<=3; i++){
    const prod = state.selectedProducts[`step${i}`];
    const cat = state.selectedCategories[`step${i}`];
    
    if(prod){ 
      html += `
        <div class="resumo-item">
          <img src="${prod.image}" class="resumo-image">
          <div class="resumo-item-info">
            <p class="resumo-item-step">Produto ${i}</p>
            <p class="resumo-item-title">${prod.title}</p>
            <p class="resumo-item-price">${formatPrice(Number(prod.price))}</p>
          </div>
        </div>
      `;
      total += Number(prod.price);
    }
  }
  
  content.innerHTML = html; 
  totalValue.textContent = `${formatPrice(total)}`;
}

function handleStepChange(step, val){
  state.selectedCategories[`step${step}`] = val;
  state.selectedProducts[`step${step}`] = null;
  displayProducts(filterProductsByCategory(val), step);
}

function updateButtons(){
  const next = document.getElementById('next-step-button');
  const finalizar = document.getElementById('finalizar-button');
  const voltar = document.getElementById('voltar-button');
  const cont = document.getElementById('next-step-button-container');
  
  if(state.showResumo){ 
    cont.style.display = 'none'; 
    return; 
  }
  
  if(state.currentStep && state.selectedProducts[`step${state.currentStep}`]){
    cont.style.display = 'flex';
    voltar.style.display = state.currentStep > 1 ? 'inline-block' : 'none';
    
    if(state.currentStep == 3){ 
      next.style.display = 'none'; 
      finalizar.style.display = 'inline-block'; 
      finalizar.disabled = false; 
    } else { 
      next.style.display = 'inline-block'; 
      finalizar.style.display = 'none'; 
      next.disabled = false; 
    }
  } else { 
    cont.style.display = 'none'; 
    next.disabled = true; 
    finalizar.disabled = true; 
  }
}

function showInitialScreen(){
  document.getElementById('products-container').innerHTML = '<p class="instruction-message">Clique em <strong>PRODUTO 1</strong> para escolher o produto</p>';
}

// Adicionar produtos ao carrinho Shopify AJAX
function addProductsToCart(){
  const items = [];
  
  for(let i=1; i<=3; i++){
    const prod = state.selectedProducts[`step${i}`];
    if(prod) items.push({ id: prod.variantId, quantity: 1 });
  }
  
  if(!items.length) return alert('Nenhum produto selecionado');
  
  fetch('/cart/add.js', {
    method:'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items })
  })
  .then(res => res.json())
  .then(data => { 
    window.location.href = '/cart';
  })
  .catch(err => { 
    console.error(err); 
    alert('Erro ao adicionar ao carrinho'); 
  });
}

// ===== INICIALIZAÇÃO =====
document.addEventListener('DOMContentLoaded', () => {
  showInitialScreen();
  initCustomDropdowns();

  document.getElementById('next-step-button').addEventListener('click', goToNextStep);
  document.getElementById('finalizar-button').addEventListener('click', showResumo);
  document.getElementById('voltar-button').addEventListener('click', goToPreviousStep);
  document.getElementById('resumo-voltar-button').addEventListener('click', goBackFromResumo);
  document.getElementById('resumo-btn').addEventListener('click', showResumo);
  document.getElementById('add-to-cart-button').addEventListener('click', addProductsToCart);
});
</script>