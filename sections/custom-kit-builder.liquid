{{ 'section_monte-seu-kit.css' | asset_url | stylesheet_tag }}

<div class="kit-builder-container">
  <div class="steps-selects">
    <!-- Step 1 -->
    <div class="step-select" data-step="1">
      <label>Passo 1</label>
      <div class="custom-dropdown" id="step1-dropdown">
        <button class="dropdown-button active" type="button">
          <span class="dropdown-label">PRODUTO 1</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="dropdown-menu" id="step1-menu"></div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step-select" data-step="2">
      <label>Passo 2</label>
      <div class="custom-dropdown disabled" id="step2-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 2</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="dropdown-menu" id="step2-menu"></div>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step-select" data-step="3">
      <label>Passo 3</label>
      <div class="custom-dropdown disabled" id="step3-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 3</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="dropdown-menu" id="step3-menu"></div>
      </div>
    </div>

    <!-- Step 4: Resumo -->
    <div class="step-select" data-step="4">
      <label>Resumo do Pedido</label>
      <div class="custom-dropdown disabled" id="step4-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">RESUMO</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4"/></svg>
        </button>
      </div>
    </div>
  </div>

  <div id="products-container" class="products-grid"></div>

  <div id="next-step-button-container" class="buttons-container" style="display:none;">
    <button id="prev-step-button" class="btn btn-secondary" style="display:none;">Voltar</button>
    <button id="next-step-button" class="btn btn-primary disabled">Pr√≥ximo passo</button>
  </div>

  <!-- Resumo do Pedido -->
  <div id="resumo-section" class="resumo-section" style="display:none;">
    <h2>Resumo do Pedido</h2>
    <div id="selected-products-content"></div>
    <div class="total-section">
      <p class="total-label">Total do Kit:</p>
      <p class="total-value" id="total-value">R$ 0,00</p>
    </div>
    <div class="buttons-container">
      <button id="voltar-button" class="btn btn-secondary">Voltar</button>
      <button id="adicionar-carrinho" class="btn btn-primary">Adicionar ao Carrinho</button>
    </div>
  </div>
</div>

<script>
const state = {
  categories: [{% for collection in collections %}"{{ collection.title | escape }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
  allProducts: [
    {% for collection in collections %}
      {% for product in collection.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ collection.title | escape }}",
        price: {{ product.price | money_without_currency | replace: ',', '.' }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last and forloop.parentloop.last %}, {% endunless %}
      {% endfor %}
    {% endfor %}
  ],
  selectedCategories: { step1:null, step2:null, step3:null },
  selectedProducts: { step1:null, step2:null, step3:null },
  displayedProducts: [],
  currentStep: 1
};

function formatPrice(price){ return 'R$ ' + Number(price).toFixed(2).replace('.', ','); }
function capitalizeFirst(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function initDropdowns(){
  ['step1','step2','step3'].forEach((step,index)=>{
    const stepNum=index+1;
    const dropdown=document.getElementById(`${step}-dropdown`);
    const button=dropdown.querySelector('.dropdown-button');
    const menu=document.getElementById(`${step}-menu`);
    state.categories.forEach(cat=>{
      const option=document.createElement('div');
      option.className='dropdown-option';
      option.textContent=capitalizeFirst(cat);
      option.dataset.value=cat;
      option.addEventListener('click',()=>selectCategory(stepNum,cat,option));
      menu.appendChild(option);
    });
    button.addEventListener('click',(e)=>{
      e.stopPropagation();
      if(!button.disabled){ closeAllDropdowns(); dropdown.classList.toggle('open'); }
    });
  });
  document.addEventListener('click',()=>closeAllDropdowns());
}

function selectCategory(step,cat,opt){
  const dd=document.getElementById(`step${step}-dropdown`);
  const label=dd.querySelector('.dropdown-label');
  label.textContent=capitalizeFirst(cat);
  dd.querySelectorAll('.dropdown-option').forEach(o=>o.classList.remove('selected'));
  opt.classList.add('selected');
  dd.classList.remove('open');
  state.selectedCategories[`step${step}`]=cat;
  displayProducts(filterProductsByCategory(cat),step);
  updateStepHighlight(step);
}

function filterProductsByCategory(cat){ return state.allProducts.filter(p=>p.category===cat); }

function createCard(prod,step){
  const card=document.createElement('div');
  card.className='product-card';
  const isSel=state.selectedProducts[`step${step}`]?.id===prod.id;
  card.innerHTML=`
    <div class="product-checkbox-container">
      <input type="checkbox" class="product-checkbox" data-step="${step}" ${isSel?'checked':''}>
    </div>
    <img src="${prod.image}" alt="${prod.title}">
    <h3>${prod.title}</h3>
    <p class="product-price">${formatPrice(prod.price)}</p>`;
  card.querySelector('.product-checkbox').addEventListener('change',e=>handleSelect(e,prod,step));
  if(!isSel && state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
  return card;
}

function displayProducts(products,step){
  const cont=document.getElementById('products-container');
  cont.innerHTML='';
  if(!products.length){ cont.innerHTML='<p>Selecione uma categoria.</p>'; return; }
  products.forEach(p=>cont.appendChild(createCard(p,step)));
  state.displayedProducts=products;
  state.currentStep=step;
  document.getElementById('next-step-button-container').style.display='flex';
  updateButtons();
}

function handleSelect(e,prod,step){
  if(e.target.checked){
    state.selectedProducts[`step${step}`]=prod;
    document.querySelectorAll(`.product-checkbox[data-step="${step}"]`).forEach(c=>{if(c!==e.target)c.checked=false;});
  }else state.selectedProducts[`step${step}`]=null;
  updateOpacity(step);
  updateButtons();
}

function updateOpacity(step){
  document.querySelectorAll('.product-card').forEach(c=>{
    const cb=c.querySelector('.product-checkbox');
    if(cb.dataset.step==step){
      if(cb.checked) c.classList.remove('product-card--disabled');
      else if(state.selectedProducts[`step${step}`]) c.classList.add('product-card--disabled');
      else c.classList.remove('product-card--disabled');
    }
  });
}

function goToNextStep(){
  if(state.currentStep<3){
    const next=state.currentStep+1;
    enableDropdown(next);
    updateStepHighlight(next);
    displayProducts([],next);
  }else if(state.currentStep===3){
    showResumo();
  }
}

function goToPrevStep(){
  if(state.currentStep>1){
    const prev=state.currentStep-1;
    updateStepHighlight(prev);
    displayProducts(filterProductsByCategory(state.selectedCategories[`step${prev}`]||''),prev);
  }
}

function updateButtons(){
  const nextBtn=document.getElementById('next-step-button');
  const prevBtn=document.getElementById('prev-step-button');
  const hasProd=!!state.selectedProducts[`step${state.currentStep}`];
  nextBtn.disabled=!hasProd;
  nextBtn.classList.toggle('disabled',!hasProd);
  prevBtn.style.display=state.currentStep>1?'inline-block':'none';
}

function enableDropdown(step){
  const dd=document.getElementById(`step${step}-dropdown`);
  dd.classList.remove('disabled');
  dd.querySelector('.dropdown-button').disabled=false;
}

function updateStepHighlight(active){
  document.querySelectorAll('.dropdown-button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`#step${active}-dropdown .dropdown-button`)?.classList.add('active');
  state.currentStep=active;
}

function showResumo(){
  document.getElementById('products-container').style.display='none';
  document.getElementById('next-step-button-container').style.display='none';
  document.getElementById('resumo-section').style.display='block';
  updateStepHighlight(4);
  renderResumo();
}

function renderResumo(){
  const cont=document.getElementById('selected-products-content');
  let html='',total=0;
  for(let i=1;i<=3;i++){
    const p=state.selectedProducts[`step${i}`];
    if(p){
      total+=Number(p.price);
      html+=`
        <div class="selected-product-item">
          <img src="${p.image}">
          <div>
            <p>${p.title}</p>
            <p class="product-price">${formatPrice(p.price)}</p>
          </div>
        </div>`;
    }
  }
  cont.innerHTML=html;
  document.getElementById('total-value').textContent=formatPrice(total);
}

function addToCart(){
  const items=[];
  for(let i=1;i<=3;i++){
    const p=state.selectedProducts[`step${i}`];
    if(p) items.push({id:p.variantId,quantity:1});
  }
  fetch('/cart/add.js',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({items})
  }).then(r=>r.json()).then(()=>{
    alert('Kit adicionado ao carrinho!');
    window.location.href='/cart';
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  initDropdowns();
  document.getElementById('next-step-button').addEventListener('click',goToNextStep);
  document.getElementById('prev-step-button').addEventListener('click',goToPrevStep);
  document.getElementById('voltar-button').addEventListener('click',()=>{ 
    document.getElementById('resumo-section').style.display='none';
    document.getElementById('products-container').style.display='grid';
    document.getElementById('next-step-button-container').style.display='flex';
    updateStepHighlight(3);
    displayProducts(filterProductsByCategory(state.selectedCategories.step3),3);
  });
  document.getElementById('adicionar-carrinho').addEventListener('click',addToCart);
});
</script>
