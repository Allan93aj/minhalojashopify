<script>
const state = {
  categories: [{% for collection in collections %}"{{ collection.title | escape }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
  allProducts: [
    {% for collection in collections %}
      {% for product in collection.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ collection.title | escape }}",
        // ConversÃ£o de preÃ§o para nÃºmero real (ex: 6990 => 69.90)
        price: {{ product.price | divided_by: 100.0 }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last and forloop.parentloop.last %}, {% endunless %}
      {% endfor %}
    {% endfor %}
  ],
  selectedCategories: { step1:null, step2:null, step3:null },
  selectedProducts: { step1:null, step2:null, step3:null },
  displayedProducts: [],
  currentStep: 1,
  showResumo: false
};

// ===== DROPDOWNS =====
function initCustomDropdowns() {
  ['step1', 'step2', 'step3'].forEach((step, index) => {
    const stepNum = index + 1;
    const dropdown = document.getElementById(`${step}-dropdown`);
    const button = dropdown.querySelector('.dropdown-button');
    const menu = document.getElementById(`${step}-menu`);

    state.categories.forEach(cat => {
      const option = document.createElement('div');
      option.className = 'dropdown-option';
      option.textContent = capitalizeFirst(cat);
      option.dataset.value = cat;
      option.addEventListener('click', () => selectDropdownOption(step, stepNum, cat, option));
      menu.appendChild(option);
    });

    button.addEventListener('click', e => {
      e.stopPropagation();
      if (!button.disabled) {
        closeAllDropdowns();
        dropdown.classList.toggle('open');
      }
    });
  });

  document.addEventListener('click', () => closeAllDropdowns());
}

function selectDropdownOption(step, stepNum, value, optionElement) {
  const dropdown = document.getElementById(`${step}-dropdown`);
  const label = dropdown.querySelector('.dropdown-label');
  label.textContent = capitalizeFirst(value);

  dropdown.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
  optionElement.classList.add('selected');
  dropdown.classList.remove('open');
  handleStepChange(stepNum, value);
}

function closeAllDropdowns() {
  document.querySelectorAll('.custom-dropdown').forEach(dd => dd.classList.remove('open'));
}

function enableDropdown(stepNum) {
  const dropdown = document.getElementById(`step${stepNum}-dropdown`);
  const button = dropdown.querySelector('.dropdown-button');
  dropdown.classList.remove('disabled');
  button.disabled = false;
}

// ===== FUNÃ‡Ã•ES BASE =====
function formatPrice(price){ return 'R$ ' + price.toFixed(2).replace('.', ','); }
function capitalizeFirst(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

// ðŸ”§ CORRIGIDO: filtro com trim + lowercase
function filterProductsByCategory(category){
  const cat = category.trim().toLowerCase();
  return state.allProducts.filter(p => p.category.trim().toLowerCase() === cat);
}

function createProductCard(product, step){
  const card = document.createElement('div');
  card.className = 'product-card';
  const checkboxId = `product-${step}-${product.id}`;
  const isSelected = state.selectedProducts[`step${step}`]?.id === product.id;
  card.innerHTML = `
    <div class="product-checkbox-container">
      <input type="checkbox" class="product-checkbox" id="${checkboxId}" data-product-id="${product.id}" data-step="${step}" ${isSelected ? 'checked' : ''}>
    </div>
    <img src="${product.image}" alt="${product.title}" class="product-image">
    <div class="product-info">
      <h3 class="product-title">${product.title.length > 50 ? product.title.substring(0,50)+'...' : product.title}</h3>
      <p class="product-category">${capitalizeFirst(product.category)}</p>
      <p class="product-price">${formatPrice(Number(product.price))}</p>
    </div>
  `;
  if(!isSelected && state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
  card.querySelector('.product-checkbox').addEventListener('change', handleProductSelection);
  return card;
}

function handleProductSelection(e){
  const cb = e.target;
  const step = cb.dataset.step;
  const product = state.displayedProducts.find(p => p.id == cb.dataset.productId);
  if(cb.checked){
    state.selectedProducts[`step${step}`] = product;
    document.querySelectorAll(`.product-checkbox[data-step="${step}"]`).forEach(x => { if(x.id !== cb.id) x.checked = false; });
  } else state.selectedProducts[`step${step}`] = null;
  updateProductCardsOpacity(step);
  updateButtons();
  updateSelectedProductsDisplay();
}

function updateProductCardsOpacity(step){
  document.querySelectorAll('.product-card').forEach(card => {
    const cb = card.querySelector('.product-checkbox');
    if(cb?.dataset.step === step){
      if(cb.checked) card.classList.remove('product-card--disabled');
      else if(state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
      else card.classList.remove('product-card--disabled');
    }
  });
}

function displayProducts(products, step){
  const container = document.getElementById('products-container');
  container.style.display = 'grid';
  container.innerHTML = '';

  if(!products.length) {
    container.innerHTML = '<p class="loading">Clique em Produto '+step+' para escolher a categoria</p>';
  } else {
    products.forEach(p => container.appendChild(createProductCard(p, step)));
  }

  state.displayedProducts = products;
  state.currentStep = step;
  updateProductCardsOpacity(step);
  updateButtons();
}

function goToNextStep(){
  if(!state.currentStep || !state.selectedProducts[`step${state.currentStep}`]) return;
  const next = parseInt(state.currentStep) + 1;
  if(next <= 3){
    enableDropdown(next);
    displayProducts([], next);
  }
}

function updateSelectedProductsDisplay(){
  const section = document.getElementById('selected-products-section');
  const content = document.getElementById('selected-products-content');
  const totalValue = document.getElementById('total-value');
  let html = '', total = 0, hasProducts = false;

  for(let i = 1; i <= 3; i++){
    const prod = state.selectedProducts[`step${i}`];
    const cat = state.selectedCategories[`step${i}`];
    if(prod){
      hasProducts = true;
      html += `
        <div class="selected-product-item">
          <div class="selected-product-number">Produto ${i}</div>
          <img src="${prod.image}" class="selected-product-image">
          <div class="selected-product-info">
            <p class="selected-product-category">${capitalizeFirst(cat)}</p>
            <p class="selected-product-title">${prod.title}</p>
            <p class="selected-product-price">${formatPrice(Number(prod.price))}</p>
          </div>
        </div>
      `;
      total += Number(prod.price);
    }
  }

  if(hasProducts){
    section.style.display = 'block';
    content.innerHTML = html;
    totalValue.textContent = formatPrice(total);
  } else {
    section.style.display = 'none';
  }
}

function handleStepChange(step, val){
  state.selectedCategories[`step${step}`] = val;
  state.selectedProducts[`step${step}`] = null;
  displayProducts(filterProductsByCategory(val), step);
  updateButtons();
}

function updateButtons(){
  const nextBtn = document.getElementById('next-step-button');
  const finalizarBtn = document.getElementById('finalizar-button');
  const container = document.getElementById('next-step-button-container');
  const hasSelectedProduct = state.selectedProducts[`step${state.currentStep}`];
  const hasSelectedCategory = state.selectedCategories[`step${state.currentStep}`];
  if(hasSelectedCategory) container.style.display = 'flex';
  else { container.style.display = 'none'; return; }

  if(hasSelectedProduct){
    nextBtn.classList.remove('disabled');
    nextBtn.disabled = false;
    finalizarBtn.disabled = false;
  } else {
    nextBtn.classList.add('disabled');
    nextBtn.disabled = true;
    finalizarBtn.disabled = true;
  }

  if(state.currentStep == 3){
    nextBtn.style.display = 'none';
    finalizarBtn.style.display = 'inline-block';
  } else {
    nextBtn.style.display = 'inline-block';
    finalizarBtn.style.display = 'none';
  }
}

function showInitialScreen(){
  document.getElementById('products-container').innerHTML = '<p class="loading">Clique em Produto 1 para escolher a categoria</p>';
}

function addProductsToCart(){
  const items = [];
  for(let i = 1; i <= 3; i++){
    const prod = state.selectedProducts[`step${i}`];
    if(prod) items.push({ id: prod.variantId, quantity: 1 });
  }
  if(!items.length) return alert('Nenhum produto selecionado');
  fetch('/cart/add.js', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ items })
  })
  .then(res => res.json())
  .then(() => { alert('Produtos adicionados ao carrinho com sucesso!'); window.location.href = '/cart'; })
  .catch(err => { console.error(err); alert('Erro ao adicionar ao carrinho'); });
}

document.addEventListener('DOMContentLoaded', () => {
  showInitialScreen();
  initCustomDropdowns();
  document.getElementById('next-step-button').addEventListener('click', goToNextStep);
  document.getElementById('finalizar-button').addEventListener('click', addProductsToCart);
});
</script>
