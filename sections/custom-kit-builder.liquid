{{ 'section_monte-seu-kit.css' | asset_url | stylesheet_tag }}

<div class="kit-builder-container">
  <div class="steps-buttons">
    <button class="step-btn active" data-step="1">Passo 1</button>
    <button class="step-btn" data-step="2">Passo 2</button>
    <button class="step-btn" data-step="3">Passo 3</button>
    <button class="step-btn" data-step="4">Resumo</button>
  </div>

  <div class="steps-selects">
    <!-- Step 1 -->
    <div class="step-select" data-step="1">
      <label>Passo 1</label>
      <div class="custom-dropdown" id="step1-dropdown">
        <button class="dropdown-button" type="button">
          <span class="dropdown-label">PRODUTO 1</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M2 4l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step1-menu"></div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step-select" data-step="2">
      <label>Passo 2</label>
      <div class="custom-dropdown disabled" id="step2-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 2</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M2 4l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step2-menu"></div>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step-select" data-step="3">
      <label>Passo 3</label>
      <div class="custom-dropdown disabled" id="step3-dropdown">
        <button class="dropdown-button" type="button" disabled>
          <span class="dropdown-label">PRODUTO 3</span>
          <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M2 4l4 4 4-4"/>
          </svg>
        </button>
        <div class="dropdown-menu" id="step3-menu"></div>
      </div>
    </div>
  </div>

  <div id="products-container" class="products-grid"></div>

  <!-- Botões final / próximo -->
  <div id="action-buttons" class="buttons-container">
    <button id="prev-step-button" class="btn btn-secondary" style="display:none;">Voltar</button>
    <button id="next-step-button" class="btn btn-primary disabled">Próximo passo</button>
    <button id="finalizar-button" class="btn btn-primary" style="display:none;">Adicionar ao Carrinho</button>
  </div>

  <!-- Resumo dos produtos -->
  <div id="selected-products-section" class="selected-products-container" style="display:none;">
    <h2>Resumo do Pedido</h2>
    <div id="selected-products-content"></div>
    <div class="total-section">
      <p class="total-label">Total do Kit:</p>
      <p class="total-value" id="total-value">R$ 0,00</p>
    </div>
  </div>
</div>

<script>
const state = {
  categories: [{% for collection in collections %}"{{ collection.title | escape }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
  allProducts: [
    {% for collection in collections %}
      {% for product in collection.products %}
      {
        id: {{ product.id }},
        title: "{{ product.title | escape }}",
        image: "{{ product.featured_image | img_url: '300x' }}",
        category: "{{ collection.title | escape }}",
        price: {{ product.variants.first.price | money_without_currency | remove: ',' | divided_by: 100 }},
        variantId: {{ product.variants.first.id }}
      }{% unless forloop.last and forloop.parentloop.last %}, {% endunless %}
      {% endfor %}
    {% endfor %}
  ],
  selectedCategories: { step1:null, step2:null, step3:null },
  selectedProducts: { step1:null, step2:null, step3:null },
  displayedProducts: [],
  currentStep: 1
};

// ===== Funções dropdown (igual anterior) =====
function initCustomDropdowns() {
  ['step1','step2','step3'].forEach((step,index)=>{
    const stepNum = index+1;
    const dropdown = document.getElementById(`${step}-dropdown`);
    const button = dropdown.querySelector('.dropdown-button');
    const menu = document.getElementById(`${step}-menu`);
    state.categories.forEach(cat=>{
      const option = document.createElement('div');
      option.className='dropdown-option';
      option.textContent=capitalizeFirst(cat);
      option.dataset.value=cat;
      option.addEventListener('click',()=>{ selectDropdownOption(step,stepNum,cat,option); });
      menu.appendChild(option);
    });
    button.addEventListener('click',e=>{
      e.stopPropagation();
      if(!button.disabled){ closeAllDropdowns(); dropdown.classList.toggle('open'); }
    });
  });
  document.addEventListener('click',()=>closeAllDropdowns());
}

function selectDropdownOption(step,stepNum,value,optionElement){
  const dropdown = document.getElementById(`${step}-dropdown`);
  dropdown.querySelector('.dropdown-label').textContent = capitalizeFirst(value);
  dropdown.querySelectorAll('.dropdown-option').forEach(opt=>opt.classList.remove('selected'));
  optionElement.classList.add('selected');
  dropdown.classList.remove('open');
  handleStepChange(stepNum,value);
}

function closeAllDropdowns(){ document.querySelectorAll('.custom-dropdown').forEach(dd=>dd.classList.remove('open')); }
function enableDropdown(stepNum){ const dropdown=document.getElementById(`step${stepNum}-dropdown`); dropdown.classList.remove('disabled'); dropdown.querySelector('.dropdown-button').disabled=false; }
function formatPrice(price){ return 'R$ '+price.toFixed(2).replace('.',','); }
function capitalizeFirst(str){ return str.charAt(0).toUpperCase()+str.slice(1); }
function filterProductsByCategory(category){ return state.allProducts.filter(p=>p.category===category); }

// ===== Criação e seleção de produtos =====
function createProductCard(product,step){
  const card=document.createElement('div'); card.className='product-card';
  const checkboxId=`product-${step}-${product.id}`;
  const isSelected = state.selectedProducts[`step${step}`]?.id===product.id;
  card.innerHTML=`
    <div class="product-checkbox-container">
      <input type="checkbox" class="product-checkbox" id="${checkboxId}" data-product-id="${product.id}" data-step="${step}" ${isSelected?'checked':''}>
    </div>
    <img src="${product.image}" alt="${product.title}" class="product-image">
    <div class="product-info">
      <h3 class="product-title">${product.title.length>50?product.title.substring(0,50)+'...':product.title}</h3>
      <p class="product-category">${capitalizeFirst(product.category)}</p>
      <p class="product-price">${formatPrice(Number(product.price))}</p>
    </div>
  `;
  if(!isSelected && state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
  card.querySelector('.product-checkbox').addEventListener('change',handleProductSelection);
  return card;
}

function handleProductSelection(e){
  const cb=e.target, step=cb.dataset.step;
  const product=state.displayedProducts.find(p=>p.id==cb.dataset.productId);
  if(cb.checked){
    state.selectedProducts[`step${step}`]=product;
    document.querySelectorAll(`.product-checkbox[data-step="${step}"]`).forEach(x=>{ if(x.id!==cb.id)x.checked=false; });
  } else state.selectedProducts[`step${step}`]=null;
  updateProductCardsOpacity(step);
  updateButtons();
  updateSelectedProductsDisplay();
}

function updateProductCardsOpacity(step){
  document.querySelectorAll('.product-card').forEach(card=>{
    const cb=card.querySelector('.product-checkbox');
    if(cb?.dataset.step===step){
      if(cb.checked) card.classList.remove('product-card--disabled');
      else if(state.selectedProducts[`step${step}`]) card.classList.add('product-card--disabled');
      else card.classList.remove('product-card--disabled');
    }
  });
}

function displayProducts(products,step){
  const container=document.getElementById('products-container'); container.style.display='grid'; container.innerHTML='';
  if(!products.length) container.innerHTML=`<p class="loading">Clique em Produto ${step} para escolher a categoria</p>`;
  else products.forEach(p=>container.appendChild(createProductCard(p,step)));
  state.displayedProducts=products; state.currentStep=step;
  updateProductCardsOpacity(step); updateButtons(); updateStepButtons();
}

// ===== Passos e resumo =====
function handleStepChange(step,val){
  state.selectedCategories[`step${step}`]=val;
  state.selectedProducts[`step${step}`]=null;
  displayProducts(filterProductsByCategory(val),step);
}

function goToNextStep(){
  if(!state.currentStep || !state.selectedProducts[`step${state.currentStep}`]) return;
  const next=state.currentStep+1;
  if(next<=4){
    if(next<=3) enableDropdown(next);
    displayProducts(next<=3?[]:[],next);
    if(next===4) showResumoStep();
    state.currentStep=next;
    updateStepButtons();
  }
}

function goToPrevStep(){
  const prev=state.currentStep-1; if(prev<1) return;
  displayProducts(prev<=3 && state.selectedCategories[`step${prev}`]?filterProductsByCategory(state.selectedCategories[`step${prev}`]):[],prev);
  state.currentStep=prev;
  updateStepButtons();
  document.getElementById('selected-products-section').style.display=prev<4?'none':'block';
}

function showResumoStep(){
  const section=document.getElementById('selected-products-section');
  const content=document.getElementById('selected-products-content');
  const totalValue=document.getElementById('total-value');
  let html='', total=0, hasProducts=false;
  for(let i=1;i<=3;i++){
    const prod=state.selectedProducts[`step${i}`]; const cat=state.selectedCategories[`step${i}`];
    if(prod){ hasProducts=true; html+=`
      <div class="selected-product-item">
        <div class="selected-product-number">Produto ${i}</div>
        <img src="${prod.image}" class="selected-product-image">
        <div class="selected-product-info">
          <p class="selected-product-category">${capitalizeFirst(cat)}</p>
          <p class="selected-product-title">${prod.title}</p>
          <p class="selected-product-price">${formatPrice(Number(prod.price))}</p>
      </div></div>`; total+=Number(prod.price);
    }
  }
  section.style.display=hasProducts?'block':'none';
  content.innerHTML=html; totalValue.textContent=formatPrice(total);
  document.getElementById('products-container').style.display='none';
}

function updateButtons(){
  const nextBtn=document.getElementById('next-step-button');
  const prevBtn=document.getElementById('prev-step-button');
  const finalizarBtn=document.getElementById('finalizar-button');
  prevBtn.style.display=state.currentStep>1?'inline-block':'none';
  if(state.currentStep<4){
    nextBtn.style.display='inline-block';
    finalizarBtn.style.display='none';
    nextBtn.disabled=!state.selectedProducts[`step${state.currentStep}`];
    nextBtn.classList.toggle('disabled',!state.selectedProducts[`step${state.currentStep}`]);
  } else { nextBtn.style.display='none'; finalizarBtn.style.display='inline-block'; finalizarBtn.disabled=false; }
}

function updateStepButtons(){
  document.querySelectorAll('.step-btn').forEach(btn=>{
    const step=parseInt(btn.dataset.step);
    if(step===state.currentStep) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}

function updateSelectedProductsDisplay(){
  if(state.currentStep===4) showResumoStep();
}

// ===== Adicionar ao carrinho =====
function addProductsToCart(){
  const items=[]; for(let i=1;i<=3;i++){ const prod=state.selectedProducts[`step${i}`]; if(prod) items.push({id:prod.variantId,quantity:1}); }
  if(!items.length) return alert('Nenhum produto selecionado');
  fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items})})
  .then(res=>res.json()).then(data=>{ alert('Produtos adicionados ao carrinho!'); window.location.href='/cart'; })
  .catch(err=>{ console.error(err); alert('Erro ao adicionar ao carrinho'); });
}

// ===== Inicialização =====
document.addEventListener('DOMContentLoaded',()=>{
  initCustomDropdowns();
  displayProducts([],1);
  document.getElementById('next-step-button').addEventListener('click',goToNextStep);
  document.getElementById('prev-step-button').addEventListener('click',goToPrevStep);
  document.getElementById('finalizar-button').addEventListener('click',addProductsToCart);
  document.querySelectorAll('.step-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{ const step=parseInt(btn.dataset.step); state.currentStep=step; displayProducts(step<=3 && state.selectedCategories[`step${step}`]?filterProductsByCategory(state.selectedCategories[`step${step}`]):[],step); updateStepButtons(); updateButtons(); if(step===4) showResumoStep(); });
  });
});
</script>
